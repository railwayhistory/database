# DE 1040.  Neumünster (ausschl) - Flensburg (einschl)
#
#      XXX  Derzeit nur ab Tarp.
#
let flefri = path("path.de.1005");
let flwhag = path("path.de.1000");
let flwlin = path("path.de.1001");
let hasfle = path("path.de.1020");
let husflw = path("path.de.12035");
let neufle = path("path.de.1040");
let slefri = path("path.de.9103");
let slesla = path("path.de.1010");

with detail = 1 {
    track(:first, neufle[:neu, :fle]);
}

with detail = 2 {
    track(:first, neufle[:neu, :fle]);
}

with detail = 3 {
    # ... - Jübeck (ausschl).
    track(:double :first :cat, neufle[:sle, :jub - 1sw]);

    with layer = -1 marker(:de.bf :removed :left, neufle[:sub] << 0.5dt);
    marker(:de.awanst :left, neufle[:sub] << 0.5dt);
    slabel(:left, neufle[:sub] << 0.5dt << 2ssw, "Schuby");

    # Jübeck
    track(:double :first :station, neufle[:jub - 1sw, :ahus + .2km]);
    marker(:de.bf :left, neufle[:jub] << 0.5dt);
    slabel(:left :bold, neufle[:jub] << 0.5dt << 2ssw,
        span(:bold :small, "Jübek")
    );

    # Jübeck (aussschl) - Flensburg Weiche (ausschl)
    #
    track(:double :first :cat, neufle[:ahus + .2km, :fws - 1ssw]);

    with layer = -2 marker(:de.hst :closed :left, neufle[:egb] << 0.5dt);
    with layer = -1 marker(:de.bf :removed :left, neufle[:egb] << 0.5dt);
    slabel(:left :closed, neufle[:egb - .5ssw] << 0.5dt << 2ssw, "Eggebek");

    with layer = -1 marker(:de.bf :removed, neufle[:tar] >> .5dt);
    marker(:de.hp, neufle[:tar] >> .5dt);
    slabel(:right, neufle[:tar - .5ssw] >> 0.5dt >> 2ssw, "Tarp");

    marker(:de.hp :removed :left, neufle[:bar] << .5dt);
    marker(:de.bk :removed :left, neufle[:bar] << .5dt);
    slabel(:left :removed, neufle[:bar - .4ssw] << .5dt << 2ssw, "Barderup");

    # Flensburg Weiche
    #
    track(:double :first :station, neufle[:fws - 1ssw, :flw + 1ssw]);
    marker(:de.bft :right, neufle[:fws] >> 0.5dt);
    slabel(:left, neufle[:fws - .5ssw] << 3.5dt, "F. Weiche Süd");
    marker(:de.bf :right, neufle[:flw] >> 0.5dt);
    slabel(
        :bottom, neufle[:flw] >> .5dt >> 2ssw + (20pt, 0pt),
        "Flensburg Weiche"
    );

    # Flensburg Weiche (ausschl) - Flensburg (ausschl)
    #
    track(:double :first :cat, neufle[:flw + 1ssw, :fle - 1ssw]);

    # Flensburg
    #
    track(:double :first :station, neufle[:fle - 1ssw, :fle + .5ssw]);
    track(:first :station,
            neufle[:fle + .5ssw, :flw + 1ssw] >> 0.5dt
        --  neufle[:flw + 1ssw + 1dl, :flw + 1ssw + 1.1dl] << 0.5dt
    );
    marker(:de.bf :left, neufle[:fle] << .5dt);
    with layer = 1 slabel(:top, neufle[:fle] << .5dt << 2ssw, "Flensburg");
}


with detail = 4 {
    # ...

    #--- point.de.Schleswig
    #
    track(:double :first :station, neufle[:sle.a, :sle.f]);

    # Gleiswechsel Südseite
    track(:station,
            neufle[:sle.a + .9dl, :sle.a + 1dl] >> 0.5dt
        --  neufle[:sle.a + 2dl, :sle.a + 2.1dl] << 0.5dt
    );

    # Gl. 803
    track(:station,
            neufle[:sle.a + 2.9dl, :sle.a + 3dl] << 0.5dt
        --  neufle[:sle.a + 4dl, :sle + .5sw] << 1.5dt
        --  neufle[:sle + .5sw + 1dl, :sle + .5sw + 1.1dl] << 0.5dt
    );

    # Gl.804
    with layer = -1 track(:station :closed,
            neufle[:sle.a + 4dl, :sle.a + 4.1dl] << 1.5dt
        --  neufle[:sle.a + 5.1dl, :asla - 3dl] << 2.5dt
    );

    # Gl. 856
    with layer = -1 track(:third :station :closed,
            slefri[:sle.ff, :sle.ff - 0.1dl]
        ..  neufle[:sle, :asla - 4dl] << 3.5dt
        --  neufle[:asla, :asla + .1dl] >> 0.5dt
    );

    # Ausfahrt nach Schleswig Altstadt
    track(:station :removed, neufle[:sle + .5sw + 1dl, :asla + 1dl] >> 1.5dt);
    with layer = -1 track(:second :station :removed,
            neufle[:asla - .1dl, :asla] >> 0.5dt
        --  neufle[:asla + 1dl, :asla + 2dl] >> 1.5dt
        ..  slesla[:a - 1dl, :a]
    );

    marker(:de.bf :right, neufle[:sle] >> 0.5dt);
    station(:left, neufle[:sle - 0.5sw] << 3.5dt - (5dt, 0dt),
        span(:medium :bold, "Schleswig"),
        hbox(:center :top,
            vbox(:left :top,
                span(:small :removed, "1010: "),
                span(:small, "1040: "),
                span(:small :removed, "9103: ")
            ),
            vbox(:right :top,
                span(:small :removed, "132,8"),
                span(:small, "138,3"),
                span(:small :removed, "3,2")
            ),
            vbox(:left :top,
                span(:small :removed, "2"),
                span(:small, "9"),
                span(:small :removed, "")
            )
        )
    );


    # Streckengleis Schleswig - Schuby
    track(:double :first :cat, neufle[:sle.f, :sub.a]);


    #--- point.de.Schuby
    track(:double :first :station, neufle[:sub.a, :sub.f]);
    track(:station, neufle[:sub.f - 3dl, :sub.f + .3km] << 1.5dt);
    track(:station,
            neufle[:sub.f - 2.1dl, :sub.f - 2dl] << 0.5dt
        --  neufle[:sub.f - 1dl, :sub.f - 0.9dl] << 1.5dt
    );
    with layer = -1 track(:station :removed,
            neufle[:sub.a + 0.9dl, :sub.a + 1dl] << 0.5dt
        --  neufle[:sub.a + 2dl, :sub - .5sw - 2dl] << 1.5dt
        --  neufle[:sub - .5sw - 1dl, :sub - .5sw - 0.9dl] << 0.5dt
    );
    with layer = -1 marker(:de.bf :left :removed, neufle[:sub] << 0.5dt);
    marker(:de.awanst :left, neufle[:sub.f] << 1.5dt);
    station(:left, neufle[:sub.f] << 1.5dt << 2sh + (10pt, 0pt),
        hbox(:center :top,
            span(:medium, "Schuby "), span(:medium :removed, "(Kr Schleswig)")
        ),
        hbox(:center :top,
            span(:small, "142,12 "), span(:small :removed, "(137,26)")
        )
    );


    # Streckengleis Schuby - Jübek
    track(:double :first :cat, neufle[:sub.f, :jub.a]);


    #--- point.de.Jübek
    #
    track(:double :first :station, neufle[:jub.a, :ahus + .2km]);
    # Gleiswechsel Südkopf
    track(:station,
            neufle[:jub.a + 1.9dl, :jub.a + 2dl] << 0.5dt
        --  neufle[:jub.a + 3dl, :jub.a + 3.1dl] >> 0.5dt
    );

    # Nebengleise Ostseite
    track(:station,
            neufle[:jub - .1dl, :jub] >> 0.5dt
        --  neufle[:jub + 1dl, :ahus - 6dl] >> 1.5dt
        --  neufle[:ahus - 5dl, :ahus - 4.9dl] >> 0.5dt
    );
    track(:station,
            neufle[:jub - .15km, :ahus - 8dl] >> 2.5dt
        --  neufle[:ahus - 7dl, :ahus - 6.9dl] >> 1.5dt
    );

    # Gleiswechsel Nordkopf
    track(:station,
            neufle[:ahus - 4.1dl, :ahus - 4dl] >> 0.5dt
        --  neufle[:ahus - 3dl, :ahus - 2.9dl] << 0.5dt
    );
    track(:second :station,
            neufle[:ahus - 2.1dl, :ahus - 2dl] << 0.5dt
        --  neufle[:ahus - 1dl, :ahus] << 1.5dt
    );
    
    # Nebengleise Westseite
    track(:station :removed, neufle[:ahus - .4km, :ahus - 2dl] << 1.5dt);
    track(:station :removed, neufle[:ahus - .4km, :ahus - 3dl] << 2.5dt);
    track(:second :station :removed,
            neufle[:jub - 0.5sw, :ahus - 5dl] << .5dt << 1sh
        --  neufle[:ahus - 2dl, :ahus - 1dl] << 1.5dt
    );
    track(:station :removed,
            neufle[:jub.a + .2km, :jub - .5sw - 4dl] << 1.5dt
        --  neufle[:jub - .5sw - 1dl, :jub - .5sw] << .5dt << 1sh
    );

    with layer = 1 marker(:de.bf :left, neufle[:jub] << 0.5dt);
    station(:open :left :right_align, neufle[:jub - .4sw] << .5dt << 2sh,
        span(:medium :bold, "Jübek"),
        hbox(:left :top,
            vbox(:left :top, span(:small, "1011: "), span(:small, "1040: ")),
            vbox(:right :top, span(:small, "0,00"), span(:small, "149,43"))
        )
    );

    
    # Streckengleis Jübek - Eggebek
    track(:double :first :cat, neufle[:ahus + .2km, :egb - 1sw]);


    #--- point.de.Eggebek
    #
    track(:double :first :station, neufle[:egb - 1sw, :egb + 1sw]);
    track(:station :removed, neufle[:egb + .6sw, :egb.eg] << 1.5dt);
    with layer = -1 track(:station :removed,
            neufle[:egb + .6sw + 0.9dl, :egb + .6sw + 1dl] << 0.5dt
        --  neufle[:egb + .6sw + 2dl, :egb + .6sw + 2.1dl] << 1.5dt
    );
    marker(:de.hst :closed :left, neufle[:egb] << 0.5dt);
    with layer = -1 marker(:de.bf :removed :left, neufle[:egb] << 0.5dt);
    station(:left :closed, neufle[:egb - 0.4sw] << 0.5dt << 1.6sw,
        "Eggebek", "156,75"
    );

    track(:double :first :cat, neufle[:egb + 1sw, :tar.a]);

    #--- point.de.Tarp
    #
    track(:double :first :station, neufle[:tar.a, :tar.f]);
    track(:station :removed,
           neufle[:tar.a + .9dl, :tar.a + 1dl] >> 0.5dt
        -- neufle[:tar.a + 2dl, :tar.a + 2.1dl] << 0.5dt
    );
    track(:station :removed,
           neufle[:tar.ts - .51ssw, :tar.ts - .5ssw] << 0.5dt
        -- neufle[:tar.ts - .5ssw + 1dl, :tar.f] << 1.5dt
        -- neufle[:tar.f + 1sw, :tar.ff] << 2.5dt
    );
    track(:station :removed,
           neufle[:tar.f - 4.1dl, :tar.f - 4dl] << 1.5dt
        -- neufle[:tar.f - 3dl, :tar.f - 2.9dl] << 0.5dt
    );
    track(:station :removed,
           neufle[:tar.f - 2.1dl, :tar.f - 2dl] << .5dt
        -- neufle[:tar.f - 1dl, :tar.f - 0.9dl] >> .5dt
    );
    marker(:de.bf :removed, neufle[:tar] >> .5dt);
    with layer = 1 marker(:de.hp :open, neufle[:tar] >> .5dt);
    station(
        :right, neufle[:tar - 0.4sw] >> 0.5dt >> 1.6sw,
        "Tarp", "161,97"
    );

    track(:double :first :cat, neufle[:tar.f, :bar - 1sw]);

    #--- point.de.Barderup
    #
    track(:double :first :station, neufle[:bar - 1sw, :bar + 1sw]);
    marker(:de.hp :removed :left, neufle[:bar] << .5dt);
    marker(:de.bk :removed :left, neufle[:bar] << .5dt);
    station(
        :left :removed, neufle[:bar - .4sw] << .5dt << 1.6sw,
        "Barderup", "162,15"
    );

    track(:double :first :cat, neufle[:bar + 1sw, :hol - 1sw]);
    with layer = 1 line_badge(:open, neufle[:bar + 1.6km], "1040");

    #--- point.de.Flensburg-Weiche
    #
    # point.de.Holzkrug
    # point.de.Flensburg-Weiche-Süd
    #
    # Gl. 1 und 2
    with layer = 0.1 track(:double :first :station, neufle[:hol - 1sw, :flw.f]);
    track(:station,
            neufle[:flw.f - 2.1dl, :flw.f - 2dl] << 0.5dt
        --  neufle[:flw.f - 1dl, :flw.f - 0.9dl] >> 0.5dt
    );

    # Gl. 3 (Husum - Stumpf)
    track(:second :station :removed,
           husflw[:flw.a, :flw.a + 1dl]
        .. neufle[:flin, :flw.f - 6dl] << 1.5dt
    );

    # Gl.4 (Lindholm - Alter Bf)
    track(:second :station :closed,
           flwlin[:flw.f, :flw.w130]
        .. neufle[:flin, :flw.f - 5dl] << 2.5dt
        -- neufle[:flw.f - 3dl, :flw.f - 2.9dl] << 0.5dt
    );
    track(:second :station :removed,
           neufle[:flw.f - 4dl, :flw.f] << 1.5dt
    );

    # Gl. 6
    track(:station :closed,
            neufle[:flin - 2.1dl, :flin - 2dl] << 5.5dt
        --  neufle[:flin, :apad - 2dl] << 3.5dt
    );

    # Gl. 32 - Gl. 7 (Richtungsgl. Rendsburg - Padborg)
    track(:station, neufle[:flw.aa, :fws - .5sw - 1dl] << 1.5dt);
    with layer = 0.9 casing(:first :station,
           neufle[:flw.wr2 - .1dl, :flw.wr2] << 1.5dt
        .. neufle[:flin, :flin + .1dl] << 4.5dt
    );
    with layer = 1 track(:first :station,
           neufle[:fws - .5sw - 2.1dl, :fws - .5sw - 2dl] << 0.5dt
        -- neufle[:fws - .5sw - 1dl, :flw.wr2] << 1.5dt
        .. neufle[:flin, :apad] << 4.5dt
        .. flwhag[:ffle - 1dl, :ffle] >> 0.5dt
    );
    
    # Verbindung Gl. 7 nach Gl. 4
    track(:station,
            neufle[:apad - 1.1dl, :apad - 1dl] << 4.5dt
        --  neufle[:apad + 1dl, :apad + 1.1dl] << 2.5dt
    );

    # Gl. 44 - Gl. 11 (Gegenrichtung Rendsburg - Padborg)
    with layer = 0.9 casing(:first :station,
           neufle[:flw.wr2 - .1dl, :flw.wr2] << 2.5dt
        .. neufle[:flin, :flin + .1dl] << 5.5dt
    );
    with layer = 1 track(:first :station,
           neufle[:fws - .5sw - .1dl, :fws - .5sw] << 1.5dt
        -- neufle[:fws - .5sw + 1dl, :flw.wr2] << 2.5dt    
        .. neufle[:flin, :apad] << 5.5dt
        .. flwhag[:ffle - 1dl, :ffle] << 0.5dt
    );

    # Gl. 13 (Güterausfahrt nach Lindholm)
    track(:station :closed,
            flwlin[:flw.w130 + .1dl, :flw.w130]
        ..  neufle[:flin, :apad] << 6.5dt
    );

    # Gl. 14
    track(:station :removed,
            neufle[:flin - .1dl, :flin] << 5.5dt
        --  neufle[:flin + 2dl, :apad - 1dl] << 7.5dt
        --  neufle[:apad + 2dl, :apad + 2.1dl] << 4.5dt
    );

    marker(:de.bf :removed :left, neufle[:hol] << 1.5dt);
    station(
        :left :removed, neufle[:hol - .4sw] << 1.5dt << 1.4sw,
        "Holzkrug", "?"
    );
    marker(:de.bft :right, neufle[:fws] >> 0.5dt);
    station(
        :right, neufle[:fws - .4sw] >> 0.5dt >> 1.6sw,
        "F. Weiche Süd", "165,58"
    );
    marker(:de.bf :right, neufle[:flw] >> 0.5dt);
    station(
        :bottom, neufle[:flw] >> 0.5dt >> 1.6sw + (20pt, 0pt),
        "Flensburg Weiche",
        #"172,92 • 45,50 • 0,00"
	vbox(:left :small,
	    span(:open,    "  1000: 172,92"),
	    span(:closed,  "  1001:     0,00"),
	    span(:open,    "  1002: 172,92"),
	    span(:open,    "  1040: 172,92"),
	    span(:removed, "12305:   45,50")
	)
    );


    track(:double :first :cat, neufle[:flw.f, :fle.a]);


    #--- Flensburg
    #
    # Gl. 1 (ex 10; aus F. Weiche)
    track(:first :station, neufle[:fle.a, :fle + .5sw] >> 0.5dt);
    track(:station,
            neufle[:fle + .5sw, :fle.fo +.5sw] >> 0.5dt
        --  neufle[:fle.fo + .5sw + 1dl, :fle.fo + .5sw + 1.1dl] << 0.5dt
    );

    # Gl. 2 (ex 9; nach F. Weiche und nach Friedensweg)
    track(:first :station,
            neufle[:fle.a, :afri] << 0.5dt
        ..  flefri[:fle.f - .1dl, :fle.f]
    );

    # Verbindung Gl. 1 nach Gl. 2 vor Fw
    track(:station,
            neufle[:fle.a + 0.9dl, :fle.a + 3dl] >> 0.5dt
        --  neufle[:fle.a + 4dl, :fle.a + 4.1dl] << 0.5dt
    );

    # Verbindung Gl. 2 nach Gl. 1 vor Fw
    track(:station,
            neufle[:fle.fw - 0.5sw - 4.1dl, :fle.fw - 0.5sw - 4dl] << 0.5dt
        --  neufle[:fle.fw - 0.5sw - 3dl, :fle.fw - 0.5sw - 2.9dl] >> 0.5dt
    );
    

    # Gl. 3 (ex 8)
    track(:station :removed,
            neufle[:fle.a, :fle.fw - .5sw - 1dl] << 1.5dt
    );
    track(:station,
            neufle[:fle.fw - .5sw - 1dl, :fle.fo - .5sw - 1dl] << 1.5dt
        --  neufle[:fle.fo - .5sw, :fle.fo - .5sw + .1dl] << 2.5dt
    );

    # Gl.4 (ex 7)
    track(:station,
            neufle[:fle.fw - .5sw - 2.1dl, :fle.fw - .5sw - 2dl] << 0.5dt
        --  neufle[:fle.fw - .5sw, :fle - .5sw] << 2.5dt
    );
    track(:second :station, neufle[:fle - .5sw, :fle.fa] << 2.5dt);

    # Abstellgleise
    track(:station :removed,
            neufle[:fle.fo - .5sw - 2dl, :afri] << 1.5dt
    );
    track(:station,
            neufle[:afri - 1.1dl, :afri - 1dl] << 0.5dt
        --  neufle[:afri, :fle.f] << 1.5dt
    );
    track(:station,
            neufle[:fle.fa - .1dl, :fle.fa] << 1.5dt
        --  neufle[:fle.fa + 1dl, :fle.wp1] << 0.5dt
        --  neufle[:fle.wp1 + 1dl, :fle.wp1 + 1.1dl] << 1.5dt
    );

    marker(:de.bf :left, neufle[:fle] << 2.5dt);
    station(
        :open :top :left_align, neufle[:fle] << 2.5dt << 1.4sw,
        "Flensburg",
	"176,23 • 80,64 • 0,00"
    );
}

